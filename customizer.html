<script src='https://cdnjs.cloudflare.com/ajax/libs/three.js/75/three.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js'></script>
<script src='js/filters.js'></script>
<script src='js/marchingcubes.js'></script>
<script src='js/mmf_object.js'></script>
<script src='js/perfect-scrollbar.jquery.min.js'></script>
<script src='js/app_controller.js'></script>
<script src='js/scenes_controller.js'></script>
<script src='js/shapes.js'></script>
<script src="https://fastcdn.org/FileSaver.js/1.1.20151003/FileSaver.min.js"></script>
<script src='js/STLBinaryExporter.js'></script>
<script src='js/data.js'></script>
<link href="css/styles.css" rel="stylesheet" type="text/css">
<link href="css/perfect-scrollbar.min.css" rel="stylesheet" type="text/css">


<script>
    var accessToken = "access_token";
    "use strict";

    function unselect_frame_css(frame) { $(frame).css("background-image", 'url(images/frame.png)');}
    function select_frame_css(frame) {
        $(frame).css("background-image", 'url(images/border.png)');
    }

    function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) return undefined;
        if (!results[2]) return undefined;
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    }

    window.onload = function() {

        window.customizer = {};
        //Global Scope Variables
        window.GLOBAL = {
            'number_of_scene': 8,
            'mc_bbox_start': -1, // only work for -1
            'mc_bbox_end': 1, // dont work for 1
        }

        window.customizer.renderer;

        var target_data = [
            {model: "sphere_sdf",
                display_name: "sphere",
                thumbnail: 'images/model01.png'},
            {model: "half_sphere_sdf",
                display_name: "half_ellipsoid",
                thumbnail: 'images/model02.png'},
            {model: "cube_sdf",
                display_name: "cube",
                thumbnail: 'images/model03.png'},
            {model: "torus_sdf",
                display_name: "torus",
                thumbnail: 'images/model04.png'},
            {model: "vertical_ellipsoid_sdf",
                display_name: "vertical_ellipsoid",
                thumbnail: 'images/model05.png'},
            {model: "horizontal_ellipsoid_sdf",
                display_name: "horizontal_ellipsoid",
                thumbnail: 'images/model06.png'},
            {model: "front_ellipsoid_sdf",
                display_name: "front_ellipsoid",
                thumbnail: 'images/model07.png'}
        ];

        $.get("/stl", function (html) {
            $(html).find('a').each(function (){
                file_url = $(this).attr('href');
                if (file_url.endsWith('.sdf')) {
                    customizer.controller.addData('left', {model: file_url, thumbnail: 'images/model01.png'});
                }
            })
        })

        var filter_data = [
            {name: 'morphing', display_name: 'Morphing'},
            {name: 'morphing_and_minecraft', display_name: 'MorphingVoxels'},
            {name: 'minecraft', display_name: 'Voxels'},
            {name: 'twist', display_name: 'Twist'},
            {name: 'lowpoly', display_name: 'LowPoly'}
        ];

        window.customizer.model_bi_dict = {};
        // potential problem since both are using number
        for (var i=0;i<customizer_data.length;i++) {
            var mmf_id = customizer_data[i].id;
            customizer.model_bi_dict[mmf_id] = i;
            customizer.model_bi_dict[i] = mmf_id;
        }

        window.customizer.filter_bi_dict = {};

        for (var i=0;i<filter_data.length;i++){
            var filter_name = filter_data[i].display_name;
            customizer.filter_bi_dict[filter_name] = i;
            customizer.filter_bi_dict[i] = filter_name;
        }

        window.customizer.target_bi_dict = {};

        for (var i=0; i<target_data.length; i++) {
            var target_display_name = target_data[i].display_name;
            customizer.target_bi_dict[target_display_name] = i;
            customizer.target_bi_dict[i] = target_display_name;
        }

        var url = window.location.href;
        var frame = parseInt(getParameterByName("frame", url));
        var model = customizer.model_bi_dict[parseInt(getParameterByName("model", url))];
        var target = customizer.target_bi_dict[getParameterByName("target", url)];
        var filter = customizer.filter_bi_dict[getParameterByName("filter", url)];

        customizer.filters = CustomizerFilters();
        customizer.shapes = CustomizerShapes();
        customizer.controller = CustomizerController(frame,model,target,filter);
        window.controller = customizer.controller;

        for (var i=0;i<customizer_data.length;i++) {
            var each_customizer_data = customizer_data[i];
            var mmf_id = each_customizer_data.id;
            var mmf_instance = new CustomizerObjectMMF(mmf_id, each_customizer_data);
            customizer.controller.addData("left", mmf_instance);
            customizer.controller.addData("right", mmf_instance);
        }


        for (var i=0;i<filter_data.length;i++){
            var filter_name = filter_data[i].name;
            customizer.controller.addData('filter', filter_name);
        }
        for (var i=0;i<target_data.length;i++) {
            var d = target_data[i];
            customizer.controller.addData("right", d);
        }

        customizer.controller.init_scenes();
        customizer.controller.init_css();

        customizer.controller.check_for_login_upload();
        customizer.controller.check_for_login_download();

    }
</script>

<script id="c_thumbnail_template_left" type="notjs">
    <div id="icons$ileft" style="width:50%; float:left;">
        <div class="thumbnail_icon" style="float:left;background-image: url($thumbnail);">
            <div style="width:100%; height:100%;">
                <div class="myBar" id="myBar$i">
                </div>
            </div>
        </div>
    </div>
</script>

<script id="c_thumbnail_template_right" type="notjs">
    <div id="icons$iright" style="width:50%; float:left;">
        <div class="thumbnail_icon" style="float:right;background-image: url($thumbnail);">
            <div style="width:100%; height:100%;">
            </div>  
        </div>
    </div>
</script>

<div id="customizer_container">
        <!-- Filters bar -->
    <div id="shadow01"></div>
    <div id="filters_container">
        <div id="customizer_name">
            3D Filters
        </div>
        <div id="filters">

            <div class="filter cant_select_text">
                <div><span>Morphing</span></div>
            </div>

            <div class="filter cant_select_text" style="line-height: 16px;">
                <div><span>Morphing<br/>& Voxels</span></div>
            </div>

            <div class="filter cant_select_text">
                <div><span>Voxels</span></div>
            </div>

            <div class="filter cant_select_text">
                <div><span>Twist</span></div>
            </div>

            <div class="filter cant_select_text">
                <div><span>LowPoly</span></div>
            </div>

        </div>
    </div>
    <div id="shadow02">
        <div id="arrow"></div>
    </div>

    <div id="content">
        <form class="reveal-modal" id="upload_form" data-reveal style="display: none;">
            <div id="form_header">
                <div id="upload_text" class="cant_select_text"><h3></h3></div>
                <div ><a class="close-reveal-modal">Ã—</a></div>
            </div>
            <hr>
            <fieldset><legend>Edit object informations</legend>
                <label>Name</label>
                <input type="text" name="name">
                <label>Description</label>
                <input type="text" name="description">
                <label>Tags</label>
                <input type="text" name="tags">
                <div id="upload_block">
                    <div id="upload_in_progress"><p></p></div>
                    <div id='upload_progress'></div><br>
                </div>
                <div style="display: block; margin: auto; text-align: center;"><input type="button" value="CONFIRM"><br></div>
            </fieldset>
        </form>
        </div>
        <div id="container">

            <!-- Screen number 01 -->
            <div class="screen">
                <div id="customizer_right">

                    <div style="margin:16px 0 10px 15px;" class="cant_select_text">Target</div>

                    <div class="view"></div>
                    <div class="line"></div>

                    <div style="margin:16px 0 5px 15px;" class="cant_select_text">Select</div>

                    <!-- right scroll area -->
                    <div id="scroll-right">
                        <div id="inner-right"></div>
                    </div>
                    <!-- right scroll area -->

                </div>
                <div id="customizer_left">

                    <div style="margin:16px 0 10px 15px;" class="cant_select_text">Model</div>

                    <div class="view"></div>
                    <div class="line"></div>

                    <div style="margin:16px 0 5px 15px;" class="cant_select_text" id="l_info_text">Select</div>

                    <!-- left scroll area -->
                    <div id="scroll-left">
                        <div id="inner-left"></div>
                    </div>
                    <!-- left scroll area -->

                </div>

                <div id="customizer_middle">

                    <div style="margin:16px 0 10px 20px;"> <span id="selected"><br/></span></div>

                    <div id="scenes_holder">
                        <canvas id="canvas"></canvas>
                    </div>

                    <div class="bottom_div" style="float:left; width:100%; height:93px;">
                        <div class="mid_button cant_select_text" id="left_mid_button" onclick="customizer.controller.download_to_local();"><div class="mid_button_text" id="download">DOWNLOAD</div></div>
                        <div class="mid_button cant_select_text" id="right_mid_button" onclick="customizer.controller.init_upload_progress();"><a href="#" class="mid_button_text" id="publish" >PUBLISH</a></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
